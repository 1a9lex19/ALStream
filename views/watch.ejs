<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>
        <%= anime.titre %> - ALStream
    </title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <nav class="navbar">
        <div class="logo"><a href="/">AL<span class="highlight">Stream</span></a></div>
        <a href="/catalog" class="btn-back">Back to Catalog</a>
    </nav>

    <div class="details-container">
        <!-- LEFT: Poster -->
        <div class="details-left">
            <div class="poster-wrapper">
                <img src="<%= anime.affiche %>" alt="<%= anime.titre %>">
            </div>
        </div>

        <!-- RIGHT: Content -->
        <div class="details-right">
            <h1 class="media-title">
                <%= anime.titre %>
            </h1>
            <div class="media-meta">
                <span><i class="fas fa-calendar-alt"></i>
                    <%= anime.date_sortie %>
                </span> â€¢
                <span><i class="fas fa-star" style="color: gold;"></i>
                    <%= anime.note %>
                </span>
            </div>

            <p
                style="color: #ccc; margin-top: 10px; font-size: 0.9rem; line-height: 1.4; max-height: 80px; overflow: hidden;">
                <%= anime.synopsis %>
            </p>

            <!-- CONTROLS CONTAINER -->
            <div class="controls-area">
                <div class="season-selector" id="seasonTabs"></div>
                <!-- LOGIQUE DE LANGUE (METHODE FOR CLASSIQUE) -->
                <% var hasVO=false; var hasVF=false; if (episodes && episodes.length> 0) {
                    for (var k = 0; k < episodes.length; k++) { if (episodes[k].langue &&
                        episodes[k].langue.toUpperCase()==='VOSTFR' ) { hasVO=true; } if (episodes[k].langue &&
                        episodes[k].langue.toUpperCase()==='VF' ) { hasVF=true; } } } var defaultLang='ALL' ; if (hasVO)
                        { defaultLang='VOSTFR' ; } else if (hasVF) { defaultLang='VF' ; } %>

                        <div class="lang-buttons">
                            <% if (hasVO) { %>
                                <button class="flag-btn vo-flag <%= defaultLang === 'VOSTFR' ? 'active' : '' %>"
                                    onclick="setLanguage('VOSTFR', this)">
                                    <span class="flag-text">VO</span>
                                </button>
                                <% } %>

                                    <% if (hasVF) { %>
                                        <button class="flag-btn vf-flag <%= defaultLang === 'VF' ? 'active' : '' %>"
                                            onclick="setLanguage('VF', this)">
                                            <span class="flag-text">VF</span>
                                        </button>
                                        <% } %>

                                            <button
                                                class="flag-btn all-flag <%= defaultLang === 'ALL' ? 'active' : '' %>"
                                                onclick="setLanguage('ALL', this)" title="Show All">
                                                <i class="fas fa-globe"></i>
                                            </button>
                        </div>
            </div>

            <hr style="border: 0; border-top: 1px solid #333; margin-bottom: 20px;">

            <!-- EPISODE GRID -->
            <div class="episodes-grid" id="gridContainer">
                <% if (!episodes || episodes.length===0) { %>
                    <p style="color:#666;">No episodes available.</p>
                    <% } else { %>

                        <% /* --- BOUCLE FOR CLASSIQUE (Anti-Bug EJS) --- */ for (var i=0; i < episodes.length; i++) {
                            var ep=episodes[i]; var playersData=JSON.stringify([{ nom: "Lecteur Principal" , url:
                            ep.lien }]); %>
                            <div class="episode-card" id="ep-card-<%= i %>" data-players='<%= playersData %>'
                                data-title="S<%= ep.saison %> - Ep <%= ep.episode %>" data-lang="<%= ep.langue %>"
                                data-season="<%= ep.saison %>" onclick="openVideo(this)">

                                <!-- Check image -->
                                <% if (ep.image) { %>
                                    <img src="<%= ep.image %>" alt="Ep <%= ep.episode %>">
                                    <% } else { %>
                                        <img src="<%= anime.affiche %>" alt="Ep <%= ep.episode %>">
                                        <% } %>

                                            <span class="lang-badge <%= ep.langue %>">
                                                <%= ep.langue %>
                                            </span>

                                            <div class="ep-info">
                                                <span class="ep-number">Episode <%= ep.episode %></span>
                                                <i class="fas fa-play-circle"></i>
                                            </div>
                            </div>
                            <% } /* Fin de la boucle for */ %>

                                <% } /* Fin du else */ %>
            </div>
        </div>
    </div>

    <!-- PLAYER OVERLAY -->
    <div class="video-overlay" id="videoModal">
        <div class="video-container-modal">
            <div class="modal-header">
                <h3 class="modal-title-text" id="modalTitle">Playing...</h3>
                <button class="btn-close-modern" onclick="closeVideo()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Zone des boutons de lecteurs -->
            <div class="player-selector" id="playerTabs"></div>

            <div class="video-wrapper">
                <iframe id="mainPlayer" src="" frameborder="0" allowfullscreen></iframe>
            </div>

            <div class="modal-controls">
                <button class="nav-btn" id="btnPrev" onclick="playPrev()">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <button class="nav-btn" id="btnNext" onclick="playNext()">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let currentLang = '<%= defaultLang %>';
        let currentSeason = 1;
        let currentPlayingCard = null;

        document.addEventListener('DOMContentLoaded', () => {
            initSeasons();
            applyFilters();
        });

        function initSeasons() {
            const cards = document.querySelectorAll('.episode-card');
            const seasons = new Set();
            for (let i = 0; i < cards.length; i++) {
                seasons.add(parseInt(cards[i].getAttribute('data-season')));
            }

            if (seasons.size === 0) return;

            const sortedSeasons = Array.from(seasons).sort((a, b) => a - b);
            currentSeason = sortedSeasons[0];

            const container = document.getElementById('seasonTabs');
            container.innerHTML = '';

            sortedSeasons.forEach(s => {
                const btn = document.createElement('button');
                btn.className = 'season-tab-btn';
                btn.innerText = 'Season ' + s;
                if (s === currentSeason) btn.classList.add('active');

                btn.onclick = () => {
                    document.querySelectorAll('.season-tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentSeason = s;
                    applyFilters();
                };
                container.appendChild(btn);
            });
        }

        function setLanguage(lang, btn) {
            currentLang = lang;
            document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            applyFilters();
        }

        function applyFilters() {
            const cards = document.querySelectorAll('.episode-card');
            cards.forEach(card => {
                const cardLang = card.getAttribute('data-lang').toUpperCase();
                const cardSeason = parseInt(card.getAttribute('data-season'));
                const langMatch = (currentLang === 'ALL' || cardLang === currentLang);
                const seasonMatch = (cardSeason === currentSeason);

                if (langMatch && seasonMatch) {
                    card.style.display = 'block';
                    card.classList.add('visible-ep');
                } else {
                    card.style.display = 'none';
                    card.classList.remove('visible-ep');
                }
            });
        }

        // --- PLAYER LOGIC ---
        let currentOpenDropdown = null;

        function openVideo(cardElement) {
            currentPlayingCard = cardElement;

            const title = cardElement.getAttribute('data-title');
            const playersAttr = cardElement.getAttribute('data-players');
            let players = [];
            try {
                if (playersAttr) players = JSON.parse(playersAttr);
            } catch (e) { console.error(e); }

            document.getElementById('videoModal').style.display = 'flex';
            document.getElementById('modalTitle').innerText = title || "Episode";

            const playerContainer = document.getElementById('playerTabs');
            playerContainer.innerHTML = '';

            if (players && players.length > 0) {
                const wrapper = document.createElement('div');
                wrapper.className = 'custom-select-wrapper';

                const trigger = document.createElement('div');
                trigger.className = 'custom-select-trigger';
                trigger.innerHTML = '<span>' + players[0].nom + '</span> <i class="fas fa-chevron-down"></i>';

                trigger.onclick = (e) => {
                    e.stopPropagation();
                    wrapper.classList.toggle('open');
                    currentOpenDropdown = wrapper;
                };

                const optionsList = document.createElement('div');
                optionsList.className = 'custom-options';

                players.forEach((player, index) => {
                    const option = document.createElement('div');
                    option.className = 'custom-option';
                    if (index === 0) option.classList.add('selected');
                    option.innerText = player.nom;

                    option.onclick = () => {
                        document.getElementById('mainPlayer').src = player.url;
                        trigger.querySelector('span').innerText = player.nom;
                        wrapper.querySelectorAll('.custom-option').forEach(op => op.classList.remove('selected'));
                        option.classList.add('selected');
                        wrapper.classList.remove('open');
                    };

                    optionsList.appendChild(option);
                });

                wrapper.appendChild(trigger);
                wrapper.appendChild(optionsList);
                playerContainer.appendChild(wrapper);

                document.getElementById('mainPlayer').src = players[0].url;

            } else {
                document.getElementById('mainPlayer').src = "";
                playerContainer.innerHTML = '<p style="color:#666;">Aucun lecteur</p>';
            }
            updateNavButtons();
        }

        window.addEventListener('click', (e) => {
            if (currentOpenDropdown) {
                if (!currentOpenDropdown.contains(e.target)) {
                    currentOpenDropdown.classList.remove('open');
                    currentOpenDropdown = null;
                }
            }
        });

        function closeVideo() {
            document.getElementById('videoModal').style.display = 'none';
            document.getElementById('mainPlayer').src = "";
            document.getElementById('playerTabs').innerHTML = "";
            currentPlayingCard = null;
        }

        function updateNavButtons() {
            const prevBtn = document.getElementById('btnPrev');
            const nextBtn = document.getElementById('btnNext');
            const visibleCards = Array.from(document.querySelectorAll('.episode-card.visible-ep'));
            const currentIndex = visibleCards.indexOf(currentPlayingCard);
            prevBtn.disabled = (currentIndex <= 0);
            nextBtn.disabled = (currentIndex === -1 || currentIndex >= visibleCards.length - 1);
        }

        function playNext() {
            const visibleCards = Array.from(document.querySelectorAll('.episode-card.visible-ep'));
            const currentIndex = visibleCards.indexOf(currentPlayingCard);
            if (currentIndex !== -1 && currentIndex < visibleCards.length - 1) {
                visibleCards[currentIndex + 1].click();
            }
        }

        function playPrev() {
            const visibleCards = Array.from(document.querySelectorAll('.episode-card.visible-ep'));
            const currentIndex = visibleCards.indexOf(currentPlayingCard);
            if (currentIndex > 0) {
                visibleCards[currentIndex - 1].click();
            }
        }
    </script>
</body>

</html>