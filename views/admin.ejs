<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('partials/head', { title: 'Admin - ALStream' }) %>
        <link rel="stylesheet" href="/public/style.css">
        <style>
            h2 {
                margin-top: 0;
                color: #8a2be2;
                font-size: 1.5rem;
                margin-bottom: 20px;
            }
        </style>
</head>

<body>
    <%- include('partials/navbar') %>
        <div class="admin-container">
            <div class="admin-header">

                <h1>Admin Dashboard</h1>
            </div>

            <!-- ============================================== -->
            <!-- NEW: PLANNING MANAGEMENT -->
            <!-- ============================================== -->
            <div class="admin-section">
                <h2><i class="fas fa-calendar-alt"></i> Planning Management</h2>
                <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 15px;">
                    Assign a release day to animes to display them on the /planning page.
                </p>

                <div style="max-height: 300px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Anime Title</th>
                                <th>Release Day</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if(animeList && animeList.length> 0) { %>
                                <% animeList.forEach(anime=> { %>
                                    <tr>
                                        <td>
                                            <%= anime.titre %>
                                        </td>
                                        <td>
                                            <form action="/admin/update-day" method="POST" style="margin: 0;">
                                                <input type="hidden" name="anime_id" value="<%= anime.id %>">
                                                <select name="jour" onchange="this.form.submit()"
                                                    class="planning-select">
                                                    <option value="">-- None --</option>
                                                    <option value="Lundi" <%=anime.jour_sortie==='Lundi' ? 'selected'
                                                        : '' %>>Lundi</option>
                                                    <option value="Mardi" <%=anime.jour_sortie==='Mardi' ? 'selected'
                                                        : '' %>>Mardi</option>
                                                    <option value="Mercredi" <%=anime.jour_sortie==='Mercredi'
                                                        ? 'selected' : '' %>>Mercredi</option>
                                                    <option value="Jeudi" <%=anime.jour_sortie==='Jeudi' ? 'selected'
                                                        : '' %>>Jeudi</option>
                                                    <option value="Vendredi" <%=anime.jour_sortie==='Vendredi'
                                                        ? 'selected' : '' %>>Vendredi</option>
                                                    <option value="Samedi" <%=anime.jour_sortie==='Samedi' ? 'selected'
                                                        : '' %>>Samedi</option>
                                                    <option value="Dimanche" <%=anime.jour_sortie==='Dimanche'
                                                        ? 'selected' : '' %>>Dimanche</option>
                                                </select>
                                            </form>
                                        </td>
                                    </tr>
                                    <% }); %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="2" style="text-align:center; padding:20px;">No animes
                                                    found.
                                                </td>
                                            </tr>
                                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 1. ADD NEW ANIME/MOVIE -->
            <div class="admin-section">
                <h2><i class="fas fa-plus-circle"></i> Add New Content</h2>
                <form action="/admin/add-work" method="POST">
                    <label>Title</label>
                    <input type="text" name="title" required placeholder="Example: One Piece">

                    <label>Image URL (Poster)</label>
                    <input type="text" name="image" placeholder="https://image.tmdb.org/...">

                    <label>Type / Categories</label>
                    <div class="tags-grid">
                        <% if(typeof categories !=='undefined' ) { %>
                            <% for (const [mainCat, tags] of Object.entries(categories)) { %>
                                <% tags.forEach(tag=> { %>
                                    <div class="tag-item">
                                        <input type="checkbox" name="tags" value="<%= tag %>" id="tag_<%= tag %>">
                                        <label for="tag_<%= tag %>" style="margin:0; font-weight:normal;">
                                            <%= tag %>
                                        </label>
                                    </div>
                                    <% }) %>
                                        <% } %>
                                            <% } else { %>
                                                <p style="color:red;">Categories not loaded properly.</p>
                                                <% } %>
                    </div>

                    <button type="submit">Add to Catalog</button>
                </form>
            </div>

            <!-- 2. ADD NEW EPISODE -->
            <div class="admin-section">
                <h2><i class="fas fa-video"></i> Add Episode</h2>
                <form action="/admin/add-episode" method="POST">

                    <label>Select Anime</label>
                    <select name="video_id" required>
                        <option value="" disabled selected>-- Choose Anime --</option>
                        <% if(animeList && animeList.length> 0) { %>
                            <% animeList.forEach(anime=> { %>
                                <option value="<%= anime.id %>">
                                    <%= anime.titre %>
                                </option>
                                <% }) %>
                                    <% } %>
                    </select>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label>Season</label>
                            <input type="number" name="season" value="1" min="1" required>
                        </div>
                        <div>
                            <label>Episode Number</label>
                            <input type="number" name="episode" min="1" required>
                        </div>
                    </div>

                    <label>Language</label>
                    <select name="language">
                        <option value="VOSTFR">VOSTFR (Subtitled)</option>
                        <option value="VF">VF (French Dub)</option>
                    </select>

                    <label>Video Link (Vidmoly / Embed)</label>
                    <input type="text" name="url" required placeholder="https://vidmoly.net/...">

                    <button type="submit">Add Episode</button>
                </form>
            </div>

            <!-- 3. REMOVE CONTENT (ANIME) -->
            <div class="admin-section" style="border-left: 4px solid #b20710;">
                <h2 style="color: #b20710;"><i class="fas fa-trash-alt"></i> Remove Anime</h2>
                <p style="color: #888; font-size: 0.9rem; margin-bottom: 10px;">Warning: Deleting an anime will delete
                    all
                    its episodes.</p>

                <form action="/admin/delete-work" method="POST"
                    onsubmit="return confirm('Are you sure you want to delete this anime and all episodes?');">
                    <select name="anime_id" required>
                        <option value="" disabled selected>-- Select Anime to Delete --</option>
                        <% if(animeList && animeList.length> 0) { %>
                            <% animeList.forEach(anime=> { %>
                                <option value="<%= anime.id %>">
                                    <%= anime.titre %> (ID: <%= anime.id %>)
                                </option>
                                <% }) %>
                                    <% } %>
                    </select>
                    <button type="submit" class="btn-delete">Delete Anime</button>
                </form>
            </div>

            <!-- 4. REMOVE SPECIFIC EPISODE -->
            <div class="admin-section" style="border-left: 4px solid #b20710;">
                <h2 style="color: #b20710;"><i class="fas fa-trash"></i> Remove Specific Episode</h2>

                <form action="/admin/delete-episode" method="POST">
                    <select name="episode_id" required class="big-select" size="10">
                        <option value="" disabled selected>-- Select Episode to Remove --</option>
                        <!-- Note: Assure-toi que episodeList est passÃ© par ton index.js si tu veux utiliser cette section -->
                        <% if(typeof episodeList !=='undefined' && episodeList && episodeList.length> 0) { %>
                            <% episodeList.forEach(ep=> { %>
                                <option value="<%= ep.id %>">
                                    <%= ep.anime_titre %> : S<%= ep.saison %> - Ep <%= ep.episode %>
                                </option>
                                <% }) %>
                                    <% } else { %>
                                        <option disabled>No episodes loaded (Check index.js route)</option>
                                        <% } %>
                    </select>
                    <button type="submit" class="btn-delete">Delete Episode</button>
                </form>
            </div>

        </div>
</body>

</html>