<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Auto Import</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .search-box input {
            flex: 1;
            padding: 15px;
            background: #111;
            border: 1px solid #444;
            color: white;
            border-radius: 8px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .tmdb-card {
            background: #1e1e1e;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #333;
        }

        .tmdb-card img {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }

        .tmdb-info {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Champ pour le lien Anime-Sama */
        .as-input {
            background: #000;
            border: 1px solid #444;
            color: #aaa;
            padding: 8px;
            border-radius: 4px;
            width: 100%;
            font-size: 0.85rem;
        }

        .btn-import {
            padding: 10px;
            background: var(--accent);
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        .btn-import:hover {
            background: #9d4edd;
        }

        .btn-import:disabled {
            background: #444;
            cursor: wait;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="logo"><a href="/">AL<span class="highlight">Stream</span></a></div>
        <a href="/" class="btn-back">Home</a>
    </nav>

    <div class="admin-wrapper">
        <div class="admin-panel" style="width: 100%; max-width: 1200px;">
            <h2>üöÄ Ultimate Auto-Importer</h2>
            <div class="search-box">
                <input type="text" id="tmdbQuery" placeholder="Search (e.g. Solo Leveling)..."
                    onkeypress="if(event.key==='Enter') search()">
                <button onclick="search()" class="btn-submit" style="width:auto; margin:0;">Search</button>
            </div>
            <div id="results" class="results-grid"></div>
        </div>
    </div>

    <script>
        async function search() {
            const query = document.getElementById('tmdbQuery').value;
            const res = await fetch('/api/search-tmdb', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });
            const data = await res.json();

            const container = document.getElementById('results');
            container.innerHTML = '';

            data.forEach(item => {
                const img = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : '';
                const card = document.createElement('div');
                card.className = 'tmdb-card';
                // On ajoute un input ID unique pour r√©cup√©rer la valeur plus tard
                const inputId = `url-${item.id}`;

                card.innerHTML = `
                    <img src="${img}">
                    <div class="tmdb-info">
                        <h3>${item.title || item.name}</h3>
                        
                        <!-- CHAMP LIEN ANIME-SAMA -->
                        <input type="text" id="${inputId}" class="as-input" placeholder="Paste Anime-Sama URL (S1) here...">
                        
                        <button class="btn-import" onclick="importItem(${item.id}, '${item.media_type}', '${inputId}', this)">
                            START AUTO-IMPORT
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function importItem(id, type, inputId, btn) {
            const url = document.getElementById(inputId).value; // On r√©cup√®re l'URL tap√©e

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-cog fa-spin"></i> Working (Wait ~1min)...';

            const res = await fetch('/api/import-tmdb', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // On envoie l'URL au serveur
                body: JSON.stringify({ tmdbId: id, mediaType: type, animeSamaUrl: url })
            });

            const data = await res.json();
            if (data.success) {
                btn.style.background = 'green';
                btn.innerHTML = 'DONE!';
                alert('Success! ' + data.title + ' added.');
            } else {
                alert('Error');
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>